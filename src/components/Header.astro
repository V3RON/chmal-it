---
import HeaderLink from "./HeaderLink.astro";
import { SITE_TITLE, NAV_LINKS } from "../consts";
import ThemeToggle from "./ThemeToggle.astro";
import Menu from "lucide-astro/Menu";
import Github from "lucide-astro/Github";
import X from "lucide-astro/X";
import XIcon from "./icons/XIcon.astro";
import { Image } from "astro:assets";
import profileImage from "../assets/profile.png";
import Button from "@/components/ui/Button.astro";
---

<header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60" style="view-transition-name: site-header;">
  <div class="container flex h-16 items-center">
    
    {/* Desktop Logo & Nav */}
    <div class="mr-4 hidden md:flex">
      <a href="/" class="mr-6 flex items-center space-x-2">
        <div class="h-8 w-8 overflow-hidden rounded-full border border-border/50 bg-muted">
          <Image 
            src={profileImage} 
            alt="Szymon Chmal" 
            class="h-full w-full object-cover"
            width={64}
            height={64}
            loading="eager"
          />
        </div>
        <span class="hidden font-bold sm:inline-block tracking-tight">
          {SITE_TITLE}
        </span>
      </a>
      <nav class="flex items-center space-x-6 text-sm font-medium">
        {NAV_LINKS.map((link) => (
          <HeaderLink href={link.href}>{link.label}</HeaderLink>
        ))}
      </nav>
    </div>

    {/* Mobile Logo */}
    <div class="flex md:hidden">
       <a href="/" class="flex items-center space-x-2">
        <div class="h-8 w-8 overflow-hidden rounded-full border border-border/50 bg-muted">
          <Image 
            src={profileImage} 
            alt="Szymon Chmal" 
            class="h-full w-full object-cover"
            width={64}
            height={64}
            loading="eager"
          />
        </div>
        <span class="font-bold tracking-tight">
          {SITE_TITLE}
        </span>
      </a>
    </div>

    {/* Right Side Actions */}
    <div class="flex flex-1 items-center justify-end space-x-4">
      <nav class="flex items-center space-x-1">
        <Button variant="ghost" size="icon" href="https://github.com/v3ron" target="_blank" rel="noreferrer">
            <Github class="h-4 w-4" />
            <span class="sr-only">GitHub</span>
        </Button>
        <Button variant="ghost" size="icon" href="https://x.com/chmalszymon" target="_blank" rel="noreferrer">
            <XIcon class="h-4 w-4" />
            <span class="sr-only">X (Twitter)</span>
        </Button>
        <ThemeToggle />
        
        {/* Mobile Menu Trigger */}
        <button type="button" id="mobile-menu-trigger" class="md:hidden inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10">
            <Menu class="h-5 w-5" />
            <span class="sr-only">Toggle Menu</span>
        </button>
      </nav>
    </div>
  </div>
</header>

{/* Mobile Menu Overlay - Outside header to ensure full viewport coverage */}
<div id="mobile-menu" class="fixed inset-0 z-[100] md:hidden invisible pointer-events-none transition-all duration-300 group" data-state="closed">
  {/* Backdrop */}
  <div id="mobile-menu-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0 group-data-[state=open]:opacity-100 pointer-events-auto cursor-pointer" aria-hidden="true"></div>
  
  {/* Panel */}
  <div id="mobile-menu-panel" class="absolute right-0 top-0 z-10 h-full w-full bg-background p-6 shadow-xl transition-transform duration-300 translate-x-full group-data-[state=open]:translate-x-0 pointer-events-auto overflow-y-auto">
    <div class="flex flex-col space-y-6">
      <div class="flex items-center justify-between">
        <span class="font-bold text-lg">{SITE_TITLE}</span>
        <button type="button" id="mobile-menu-close" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
          <X class="h-6 w-6" />
          <span class="sr-only">Close</span>
        </button>
      </div>
      <nav class="flex flex-col space-y-4">
        {NAV_LINKS.map((link) => (
          <a href={link.href} class="text-lg font-medium transition-colors hover:text-primary">{link.label}</a>
        ))}
      </nav>
    </div>
  </div>
</div>

<script>
  function initMobileMenu() {
    const trigger = document.getElementById('mobile-menu-trigger');
    const close = document.getElementById('mobile-menu-close');
    const backdrop = document.getElementById('mobile-menu-backdrop');
    const menu = document.getElementById('mobile-menu');

    if (!trigger || !close || !backdrop || !menu) return;

    const toggleMenu = (isOpen: boolean) => {
      if (isOpen) {
        menu.setAttribute('data-state', 'open');
        menu.classList.remove('invisible', 'pointer-events-none');
        document.body.style.overflow = 'hidden';
        
        // Focus close button when menu opens
        setTimeout(() => close.focus(), 100);
      } else {
        menu.setAttribute('data-state', 'closed');
        menu.classList.add('pointer-events-none');
        // Wait for transition to complete
        setTimeout(() => {
          if (menu.getAttribute('data-state') === 'closed') {
            menu.classList.add('invisible');
            document.body.style.overflow = '';
            // Return focus to trigger
            trigger.focus();
          }
        }, 300);
      }
    };

    // Focus trap
    menu.addEventListener('keydown', (e) => {
      if (menu.getAttribute('data-state') !== 'open') return;

      if (e.key === 'Escape') {
        toggleMenu(false);
        return;
      }

      if (e.key === 'Tab') {
        const focusableElements = menu.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusableElement = focusableElements[0] as HTMLElement;
        const lastFocusableElement = focusableElements[focusableElements.length - 1] as HTMLElement;

        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      }
    });

    trigger.addEventListener('click', () => toggleMenu(true));
    close.addEventListener('click', () => toggleMenu(false));
    backdrop.addEventListener('click', () => toggleMenu(false));

    // Close on link click
    menu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => toggleMenu(false));
    });
  }

  // Initialize on page load and after view transitions
  initMobileMenu();
  document.addEventListener('astro:page-load', initMobileMenu);
</script>
